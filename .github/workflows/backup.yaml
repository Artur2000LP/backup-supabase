name: respaldo-supabase

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *" # Se ejecuta todos los dÃ­as a medianoche

env:
  BACKUP_ENABLED: true

jobs:
  ejecutar_respaldo_bd:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
      BACKUP_ENABLED: ${{ vars.BACKUP_ENABLED }} # Variable del repositorio (true o false)
    steps:
      - name: Verificar si los respaldos estÃ¡n habilitados
        run: |
          if [ "$BACKUP_ENABLED" != "true" ]; then
            echo "Los respaldos estÃ¡n deshabilitados. Saliendo del flujo de trabajo."
            exit 0
          fi

      - name: Clonar repositorio
        if: env.BACKUP_ENABLED == 'true'
        uses: actions/checkout@v3

      - name: Configurar CLI de Supabase
        if: env.BACKUP_ENABLED == 'true'
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Crear carpeta con fecha
        if: env.BACKUP_ENABLED == 'true'
        run: |
          BACKUP_DATE=$(date +%Y-%m-%d)
          BACKUP_TIME=$(date +%H-%M-%S)
          BACKUP_DIR="prisma/backups/$BACKUP_DATE"
          mkdir -p "$BACKUP_DIR"
          echo "BACKUP_DIR=$BACKUP_DIR" >> $GITHUB_ENV
          echo "BACKUP_DATE=$BACKUP_DATE" >> $GITHUB_ENV
          echo "BACKUP_TIME=$BACKUP_TIME" >> $GITHUB_ENV
          echo "Creando respaldo en: $BACKUP_DIR"

      - name: Respaldar roles
        if: env.BACKUP_ENABLED == 'true'
        run: |
          echo "Respaldando roles..."
          supabase db dump --db-url "$SUPABASE_DB_URL" -f "$BACKUP_DIR/roles.sql" --role-only
          echo "âœ… Respaldo de roles completado"

      - name: Respaldar esquema
        if: env.BACKUP_ENABLED == 'true'
        run: |
          echo "Respaldando esquema..."
          supabase db dump --db-url "$SUPABASE_DB_URL" -f "$BACKUP_DIR/schema.sql"
          echo "âœ… Respaldo de esquema completado"

      - name: Respaldar datos
        if: env.BACKUP_ENABLED == 'true'
        run: |
          echo "Respaldando datos..."
          supabase db dump --db-url "$SUPABASE_DB_URL" -f "$BACKUP_DIR/data.sql" --data-only --use-copy
          echo "âœ… Respaldo de datos completado"

      - name: ðŸ”’ Encriptar archivos sensibles
        if: env.BACKUP_ENABLED == 'true'
        env:
          ENCRYPTION_KEY: ${{ secrets.BACKUP_ENCRYPTION_KEY }}
        run: |
          echo "ðŸ” Encriptando archivos de backup..."
          
          # Instalar herramientas de encriptaciÃ³n
          sudo apt-get update && sudo apt-get install -y gpg
          
          # Encriptar archivos sensibles
          echo "$ENCRYPTION_KEY" | gpg --batch --yes --passphrase-fd 0 --symmetric --cipher-algo AES256 --output "$BACKUP_DIR/roles.sql.enc" "$BACKUP_DIR/roles.sql"
          echo "$ENCRYPTION_KEY" | gpg --batch --yes --passphrase-fd 0 --symmetric --cipher-algo AES256 --output "$BACKUP_DIR/schema.sql.enc" "$BACKUP_DIR/schema.sql"  
          echo "$ENCRYPTION_KEY" | gpg --batch --yes --passphrase-fd 0 --symmetric --cipher-algo AES256 --output "$BACKUP_DIR/data.sql.enc" "$BACKUP_DIR/data.sql"
          
          # Eliminar archivos sin encriptar
          rm -f "$BACKUP_DIR/roles.sql" "$BACKUP_DIR/schema.sql" "$BACKUP_DIR/data.sql"
          
          # Crear archivo de verificaciÃ³n
          echo "Archivos encriptados correctamente con AES256" > "$BACKUP_DIR/ENCRYPTED_README.txt"
          echo "Para desencriptar: gpg --decrypt archivo.sql.enc > archivo.sql" >> "$BACKUP_DIR/ENCRYPTED_README.txt"
          
          echo "âœ… EncriptaciÃ³n completada - Datos protegidos"

      - name: Crear enlace a Ãºltimo respaldo
        if: env.BACKUP_ENABLED == 'true'
        run: |
          cd prisma/backups
          rm -f latest
          ln -s "$BACKUP_DATE" latest
          echo "Ãšltimo respaldo enlazado a: $BACKUP_DATE"

      - name: Crear manifiesto del respaldo
        if: env.BACKUP_ENABLED == 'true'
        run: |
          cat > "$BACKUP_DIR/manifest.json" << EOF
          {
            "fecha_respaldo": "$BACKUP_DATE",
            "hora_respaldo": "$BACKUP_TIME",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "archivos_encriptados": {
              "roles": "roles.sql.enc",
              "esquema": "schema.sql.enc", 
              "datos": "data.sql.enc"
            },
            "encriptacion": "AES256",
            "version_supabase_cli": "$(supabase --version | cut -d' ' -f3)",
            "nota_seguridad": "Todos los archivos SQL estÃ¡n encriptados. Usa BACKUP_ENCRYPTION_KEY para desencriptar."
          }
          EOF
          echo "Manifiesto de respaldo creado"

      - name: Confirmar respaldos
        if: env.BACKUP_ENABLED == 'true'
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: Respaldo de Supabase
